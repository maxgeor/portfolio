---
interface Props {
  src: string;
  previewSrc: string;
  alt: string;
  width?: number;
  height?: number;
  class?: string;
  transitionDelay?: number;
}

const { 
  src, 
  previewSrc, 
  alt, 
  width, 
  height, 
  class: className = '',
  transitionDelay = 100
} = Astro.props;

const createImageProps = (src: string, alt: string, width?: number, height?: number) => {
  const props: Record<string, any> = { src, alt };
  if (width) props.width = width;
  if (height) props.height = height;
  return props;
};
---

<div class={`relative overflow-hidden ${className}`} style={width && height ? `aspect-ratio: ${width}/${height}` : undefined}>
  <div class="absolute inset-0 overflow-hidden">
    <img
      {...createImageProps(previewSrc, alt, width, height)}
      class="preview-image absolute inset-0 w-full h-full object-cover select-none transition-opacity duration-300 scale-110"
      style="opacity: 1; filter: blur(5px);"
      aria-hidden="true"
    />
  </div>
  <img
    {...createImageProps(src, alt, width, height)}
    class="full-image absolute inset-0 w-full h-full object-cover select-none transition-opacity duration-300"
    style="opacity: 0;"
    loading="lazy"
    data-transition-delay={transitionDelay}
  />
</div>

<script>
  function handleImageLoad(img: HTMLImageElement) {
    const prevImgContainer = img.previousElementSibling as HTMLDivElement | null;
    const prevImg = prevImgContainer?.querySelector('img.preview-image');

    const transitionDelay = parseInt(img.dataset.transitionDelay || '100', 10);

    setTimeout(() => {
      img.style.opacity = '1';
      if (prevImg instanceof HTMLImageElement) {
        prevImg.style.opacity = '0';
      }
    }, transitionDelay);
  }

  function setupImage(img: HTMLImageElement) {
    if (img.complete && img.naturalWidth !== 0) {
      handleImageLoad(img);
    } else {
      img.addEventListener('load', () => handleImageLoad(img));
    }

    img.addEventListener('error', () => {
      console.error(`Failed to load image: ${img.src}`);
      img.style.display = 'none';
      const prevImgContainer = img.previousElementSibling as HTMLDivElement | null;
      const prevImg = prevImgContainer?.querySelector('img.preview-image');
      if (prevImg instanceof HTMLImageElement) {
        prevImg.style.opacity = '1';
        prevImg.style.filter = 'none';
        prevImg.style.transform = 'scale(1)';
      }
    });
  }

  function setupImages() {
    const images = document.querySelectorAll('img.full-image[loading="lazy"]') as NodeListOf<HTMLImageElement>;
    images.forEach(setupImage);
  }

  document.addEventListener('astro:page-load', setupImages);

  if (typeof window !== 'undefined') {
    window.addEventListener('load', setupImages);
  }

  if (document.readyState === 'complete') {
    setupImages();
  } else {
    document.addEventListener('DOMContentLoaded', setupImages);
  }
</script>