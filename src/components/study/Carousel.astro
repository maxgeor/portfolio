---
import Image from "./Image.astro";
import Video from "./Video.astro";
import Caption from "./Caption.astro";

export interface Props {
  slides: {
    type: "image" | "video";
    src: string;
    alt: string;
    span?: number | { 
      base: number, 
      sm?: number, 
      md?: number, 
      lg?: number, 
      xl?: number 
    };
    hasPadding?: boolean;
    hasBorder?: boolean;
    classes?: string;
  }[];
  span?: number | { 
    base: number, 
    sm?: number, 
    md?: number, 
    lg?: number, 
    xl?: number 
  };
  orientation?: 'horizontal' | 'vertical';
  hasBorder?: boolean
  classes?: string;
}

const { slides, orientation = 'horizontal', hasBorder, span = 12, classes = "" } = Astro.props;
---

<div class={`carousel grid grid-cols-12 gap-15 relative h-fit ${classes} ${span}`}>
  <div class={`flex gap-1 text-inherit absolute top-[7px] right-0`}>
    {slides?.map((_, index) => (
      <span 
        class={`dot h-[5px] w-[5px] bg-neutral-600 dark:bg-neutral-300 rounded-full ${index === 0 ? 'active ' : 'opacity-[35%]'}`}
      ></span>
    ))}
  </div>
  <div class={`
    flex flex-col gap-2 col-span-full 
  `}>
    <div class="flex flex-col gap-5">
      <div class="relative min-h-[15px] w-full rotate-0 overflow-hidden">
        {slides?.map((slide, index) => (
          <div class={`slide-caption slide-caption-${index} absolute h-fit w-full transition-all duration-[450ms] ease-in-out`}>
            <p>{slide.alt}</p>
          </div>
        ))}
      </div>
      <div class={`
        relative w-full rotate-0 overflow-hidden 
        ${orientation === 'vertical' ? 'aspect-[2/3]' : 'aspect-[7/4]'}
        ${hasBorder ? 'border border-neutral-200 dark:border-neutral-800' : ''}
      `}>
        <button aria-label="Next slide" class={`btn-next absolute inset-0 opacity-0`}></button>
        {
          slides?.map((slide, index) => (
            <div class={`
              slide slide-${index} 
              absolute h-fit w-full transition-all duration-[450ms] ease-in-out z-10
            `}>
              {slide.type === "video" ? (
                <Video
                  src={slide.src}
                  alt={slide.alt}
                  span={slide.span || 12}
                  hasPadding={slide.hasPadding}
                  hasBorder={false}
                  hasCaption={false}
                  classes={slide.classes}
                />
              ) : (
                <Image
                  src={slide.src}
                  alt={slide.alt}
                  span={slide.span}
                  hasPadding={slide.hasPadding}
                  hasBorder={false}
                  orientation={orientation}
                  hasCaption={false}
                  classes={slide.classes}
                />
              )}
            </div>
          ))
        }
      </div>
    </div>
  </div>
</div>

<style>
  .light-border::after {
    box-shadow: inset 0 0 0 1px RGBA(255,255,255,0.09);
    content: '';
    display: block;
    height: 100%;
    position: absolute;
    top: 0;
    width: 100%;
  }

  .dark-border::after {
    box-shadow: inset 0 0 0 1px RGBA(0,0,0,0.09);
    content: '';
    display: block;
    height: 100%;
    position: absolute;
    top: 0;
    width: 100%;
  }
  
  .slide-titles > button > div {
    opacity: 0.4;
  }

  .slide-titles > button.active > div {
    opacity: 1;
  }
  
  .slide-titles > button:hover > div {
    opacity: 1;
  }
</style>

<script>
  const carousels: NodeListOf<HTMLElement> = document.querySelectorAll(".carousel");

  carousels?.forEach((carousel) => {
    const slides: NodeListOf<HTMLElement> = carousel.querySelectorAll(".slide");
    const slideCaptions: NodeListOf<HTMLElement> = carousel.querySelectorAll(".slide-caption");
    const counters = carousel.querySelectorAll(".counter-current") as NodeListOf<HTMLElement>;
    const slideTitles: NodeListOf<HTMLButtonElement> = carousel.querySelectorAll(".slide-title");
    const prevSlideBtns = carousel.querySelectorAll(".btn-prev") as NodeListOf<HTMLButtonElement>;
    const nextSlideBtns = carousel.querySelectorAll(".btn-next") as NodeListOf<HTMLButtonElement>;

    let curSlide = 0;

    const isFirstSlide = () => curSlide === 0;
    const isLastSlide = () => curSlide === slides.length - 1;

    const slideTo = (position: number) => {
      curSlide = position;

      slides.forEach((slide, index) => {
        slide.style.transform = `translateX(${100 * (index - position)}%)`;
        slideCaptions[index].style.transform = `translateX(${100 * (index - position)}%)`;
      });

      if (counters.length > 0) {
        counters.forEach(counter => counter.innerHTML = `${curSlide + 1}`)
      }

      if (nextSlideBtns.length > 0) {
        nextSlideBtns.forEach(btn => {
          if (!isLastSlide() && btn.disabled) {
            btn.disabled = false;
            btn.style.opacity = "100%";
          } else if (isLastSlide() && !btn.disabled) {
            btn.disabled = true;
            btn.style.opacity = "40%";
          }
        });
      }

      if (prevSlideBtns.length > 0) {
        prevSlideBtns.forEach(btn => {
          if (!isFirstSlide() && btn.disabled) {
            btn.disabled = false;
            btn.style.opacity = "100%";
          } else if (isFirstSlide() && !btn.disabled) {
            btn.disabled = true;
            btn.style.opacity = "40%";
          }
        });
      }

      slideTitles.forEach(slide => {
        slide.classList.contains(`slide-title-${curSlide}`)
          ? slide.classList.add('active')
          : slide.classList.remove('active');
      });
    }

    slides.forEach((slide, index) => {
      slide.style.transform = `translateX(${index * 100}%)`
      slideCaptions[index].style.transform = `translateX(${index * 100}%)`
    });

    slideTitles.forEach(title => title.addEventListener('click', () => {
      const position = parseInt(title.dataset?.position || '0');
      slideTo(position);
    }));

    if (prevSlideBtns.length > 0) {
      prevSlideBtns.forEach(btn => {
        btn.addEventListener("click", () => slideTo(curSlide - 1));
      });
    }

    if (nextSlideBtns.length > 0) {
      nextSlideBtns.forEach(btn => {
        btn.addEventListener("click", () => slideTo(curSlide + 1));
      });
    }
  });
</script>
