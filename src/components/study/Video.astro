---
import PauseIcon from "../icons/PauseIcon.astro";
import { stripExtension } from "../../utils/formatting";

export interface Props {
  src: string;
  alt: string;
  id: string;
  span: number | { 
    base: number, 
    sm?: number, 
    md?: number, 
    lg?: number, 
    xl?: number 
  };
  description?: string;
  hasPadding?: boolean;
  hasBorder?: boolean;
  orientation?: 'vertical' | 'horizontal';
  classes?: string;
}

const {
  src, 
  alt,
  id,
  span = 12,
  description = "",
  hasPadding = false,
  hasBorder = false,
  orientation = 'horizontal',
  classes = "" 
} = Astro.props;

const extensionlessSrc = stripExtension(src);

let colClasses = '';
let spanClasses = '';

switch (typeof span) {
  case 'number':
    colClasses = `grid-cols-${span}`;
    spanClasses = `col-span-${span}`;
    break;
  case 'object':
    for (const [breakpoint, cols] of Object.entries(span)) {
      if (breakpoint === 'base') {
        colClasses += `grid-cols-${cols} `;
        spanClasses += `col-span-${cols} `;
      } else {
        colClasses += `${breakpoint}:grid-cols-${cols} `;
        spanClasses += `${breakpoint}:col-span-${cols} `;
      }
    }
    break;
}
---
<div
  id={id}
  class={`grid gap-x-[15px] gap-y-[5px] h-fit ${colClasses} ${spanClasses} ${classes}`}
>
  <div class="flex gap-[15px] col-span-full h-fit">
    <p class="leading-[15px]">{id}</p>
    <p class="leading-[15px]">{alt}</p>
  </div>
  <!-- <div class={`
    relative grid col-span-full gap-x-[15px] overflow-visible cursor-pointer transition duration-[250ms] ease-out
    ${colClasses}
    ${hasPadding ? '-mx-3 px-3 xs:mx-0 xs:px-0' : ''}
    ${orientation === 'vertical' ? 'aspect-[2/3]' : 'aspect-[7/4]'}
    ${hasBorder ? 'with-border' : ''}
  `}> -->
  <div class={`
    relative grid col-span-full gap-x-[15px] overflow-visible cursor-pointer transition duration-[250ms] ease-out
    ${colClasses}
    ${hasPadding ? '-mx-3 px-3 xs:mx-0 xs:px-0' : ''}
    ${orientation === 'vertical' ? 'aspect-[2/3]' : 'aspect-[7/4]'}
    ${hasBorder ? 'with-border' : ''}
  `}>
    <video
      class={`
         bg-[#f5f6f8] object-cover w-full select-none self-center 
        ${orientation === 'vertical' ? 'aspect-[2/3]' : 'aspect-[7/4]'}
        ${hasPadding ? 'col-start-2 col-end-[-2]' : 'col-span-full'}
      `}
      poster={extensionlessSrc + ".png"}
      playsinline
      autoplay
      muted
      loop
    >
      <source src={extensionlessSrc + ".mp4"} type="video/mp4" />
    </video>
    <PauseIcon
      classes="pause-icon transform opacity-0 brightness-100 -rotate-[24deg] -translate-x-5 z-10 absolute top-[12px] left-[10px] transition-all duration-200 ease-in-out text-white pointer-events-none drop-shadow-md"
    />
  </div>
  {description && <p class="col-span-full mt-[5px]">{description}</p>}
</div>

<style>
  .with-border::after {
    box-shadow: inset 0 0 0 1px RGBA(0,0,0,0.065);
    content: '';
    display: block;
    height: 100%;
    position: absolute;
    top: 0;
    width: 100%;
  }

</style>

<script>
  document.querySelectorAll("video")?.forEach((video) => {
    const videoTarget = video.parentElement;
    const pauseIcon = videoTarget?.querySelector(".pause-icon") as HTMLElement;

    const pauseVideo = () => {
      video.pause();
      videoTarget?.classList.add("brightness-[95%]");
      videoTarget?.classList.remove(
        'hover:brightness-[98%]',
        'focus:brightness-[99%]'
      );
      pauseIcon.classList.remove(
        "opacity-0",
        "-rotate-[24deg]",
        "-translate-x-5",
      );
    };

    const playVideo = () => {
      video.play();
      videoTarget?.classList.remove("brightness-[95%]", "ease-in-out");
      videoTarget?.classList.add(
        'hover:brightness-[98%]',
        'focus:brightness-[98%]'
      );
      pauseIcon.classList.add(
        "ease-in",
        "opacity-0",
        "rotate-[12deg]",
        "-translate-x-5"
      );

      setTimeout(() => {
        pauseIcon.classList.remove("ease-in", "rotate-[12deg]");
        pauseIcon.classList.add("-rotate-[24deg]", "ease-in-out");
      }, 200);
    };

    videoTarget?.addEventListener("click", () => {
      if (video.paused) {
        playVideo();
      } else {
        pauseVideo();
      }
    });
  });
</script>


