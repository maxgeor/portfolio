---
import PauseIcon from "../icons/PauseIcon.astro";

export interface Props {
  src: string;
  classes?: string;
}
const { src, classes = "" } = Astro.props;

const extensionlessSrc = src.replace(/\..*$/, ""); // video.mp4 -> video
---

<div class="relative">
  <video
    class={`transition duration-[250ms] ease-out col-span-full xl:col-start-2 xl:col-end-8 aspect-[7/4] object-cover w-full border border-[#ececec] rounded-lg dark:brightness-90 select-none ${classes}`}
    poster={extensionlessSrc + ".png"}
    playsinline
    autoplay
    muted
    loop
  >
    <source
      src={extensionlessSrc + "-small.mp4"}
      type="video/mp4"
      media="all and (max-width: 480px)"
    />
    <source
      src={extensionlessSrc + "-small.webm"}
      type="video/webm"
      media="all and (max-width: 480px)"
    />
    <source src={extensionlessSrc + ".mp4"} type="video/mp4" />
    <source src={extensionlessSrc + ".webm"} type="video/webm" />
  </video>
  <PauseIcon
    classes="pause-icon transform opacity-0 -rotate-[24deg] -translate-x-5 z-10 absolute top-4 left-[13px] transition-all duration-200 ease-in-out text-white pointer-events-none drop-shadow"
  />
</div>

<script>
  const videos = document.querySelectorAll("video");

  videos.forEach((video) => {
    let isFrozen = false;
    const isMobileOrTablet = () =>
      /Android|webOS|iPhone|iPad|iPod|BlackBerry|BB|PlayBook|IEMobile|Windows Phone|Kindle|Silk|Opera Mini/i.test(
        navigator.userAgent
      );

    const pause = video.parentElement?.querySelector(
      ".pause-icon"
    ) as HTMLElement;

    const pauseVideo = () => {
      video.pause();
      video.classList.add("brightness-75");
      video.classList.remove("dark:brightness-90");
      pause.classList.remove("opacity-0", "-rotate-[24deg]", "-translate-x-5");
    };

    const playVideo = () => {
      video.play();
      video.classList.add("dark:brightness-90");
      video.classList.remove("brightness-75", "ease-in-out");
      pause.classList.add(
        "ease-in",
        "opacity-0",
        "rotate-[12deg]",
        "-translate-x-5"
      );

      setTimeout(() => {
        pause.classList.remove("ease-in", "rotate-[12deg]");
        pause.classList.add("-rotate-[24deg]", "ease-in-out");
      }, 200);
    };

    video.addEventListener("mouseover", () => {
      if (isFrozen || isMobileOrTablet()) return;

      pauseVideo();
    });

    video.addEventListener("mouseout", () => {
      if (isFrozen || isMobileOrTablet()) return;

      playVideo();
    });

    video.addEventListener("click", () => {
      if (video.paused) {
        isFrozen = false;
        playVideo();
      } else {
        isFrozen = true;
        pauseVideo();
      }
    });
  });
</script>
